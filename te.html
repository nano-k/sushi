<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>検閲世界</title>

<style>
  body {
    margin: 0;
    background: #fff;
    font-family: "Hiragino Mincho ProN", "MS Mincho", serif;
    overflow: hidden;
  }

  /* 中央文字 */
  #text {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    color: black;
    opacity: 0;
    transition: opacity 1.2s linear;
    pointer-events: none;
  }

  #mosaic {
    position: fixed;
    top: 0;
    left: 0;
  }
</style>

</head>
<body>

<canvas id="mosaic"></canvas>
<div id="text">検閲世界</div>

<script>
const canvas = document.getElementById("mosaic");
const ctx = canvas.getContext("2d");
const textEl = document.getElementById("text");

// 画面サイズを確実に反映
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

// 初期モザイクサイズ（粗い）
let tileSize = 140;
// 最小タイルサイズ
const limitSize = 6;
// タイル縮小率
const shrinkRate = 0.90; // だいたい10%ずつ小さくなる

// 安定乱数（暗くなりすぎない）
function tileColor() {
  const v = Math.random();
  if (v > 0.66) return "#111";
  if (v > 0.33) return "#333";
  return "#555";
}

// モザイク生成
function draw(size) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (let y = 0; y < canvas.height; y += size) {
    for (let x = 0; x < canvas.width; x += size) {
      ctx.fillStyle = tileColor();
      ctx.fillRect(x, y, size, size);
    }
  }
}

// 進行フラグ
let showedText = false;

// アニメーションループ
function animate() {
  draw(tileSize);
  tileSize *= shrinkRate;

  // テキスト表示（絶対発火するように数値で条件管理）
  if (!showedText && tileSize < 40) {
    textEl.style.opacity = 1;
    showedText = true;
  }

  // 終了処理：モザイク除去
  if (tileSize <= limitSize) {
    // 一旦描画を止める
    setTimeout(() => {
      canvas.style.transition = "opacity 1s linear";
      canvas.style.opacity = 0;

      setTimeout(() => {
        canvas.remove(); // 絶対消える
      }, 1200);
    }, 500);

    return;
  }

  requestAnimationFrame(animate);
}

// 開始
animate();
</script>

</body>
</html>
